<!--<div class="widget ">-->
<div class="innerAll">
  <h4 class="margin-none strong">
    <a url="<%= history_jobs_path %>" href="<%= history_jobs_path %>" data-toggle="modal"><%= t('history_job.title_history_job') %></a>
  </h4>

  <div class="clearfix"></div>
</div>
<div class="widget innerLR">
  <div class="innerAll border-bottom" id="historyjob_new">
    <ul class="media-list margin-none">
      <a class="historyJob" url="<%= new_history_job_path %>" href="#" data-toggle="modal" modal_title="<%= t('history_job.title_new_history_job') %>">
        <li class="media">
                <span class="pull-left innerAll half empty-photo">
                    <i class="fa fa-plus" style="margin-left: 3px; margin-right: 3px;"></i>
                  <%= t('history_job.title_new_history_job') %>
                </span>
        </li>
      </a>
    </ul>

  </div>
  <div id="history_jobs_list" class="widget-body padding-none">
    <%= render @history_jobs %>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="historyJobModal" tabindex="-1" role="dialog" aria-labelledby="historyJobModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="historyJobModalLabel">Modal title</h4>
      </div>
      <div id="modalContentHistoryJob" class="modal-body" style="max-height: 760px; overflow-y: auto">
      </div>
      <div class="modal-footer">
        <button id="btnSaveHistoryJob" type="button" class="btn btn-primary"><%= t('button.btn_save') %></button>
        <button type="button" class="btn btn-default" data-dismiss="modal"><%= t('button.btn_cancel') %></button>
      </div>
    </div>
  </div>
</div>


<script>
    $(document).ready(function () {
        $('#historyJobModal').on('shown.bs.modal', function() {
            $('#history_job_company_name').focus();
        })
        $('a.historyJob').click(function (e) {
            openHistoryJobModal(this, e);
        });

        $('a.editHistoryJob').click(function (e) {
            openEditHistoryJobModal(this, e);
        });

        $('a.deleteHistoryJob').click(function (e) {
            processDeleteHistoryJob(this, e);
        });

        $("#btnSaveHistoryJob").click(function () {
            $("p.has-error").remove();
            $(".has-error").removeClass("has-error");

            $("#history_job_form").validate({
                onfocusout: false,
                onkeyup: false,
                rules: {
                    "history_job[company_name]": {
                        required: {
                            depends: function () {
                                var text = $.trim($(this).val());
                                text = text.replace(/\s+/g, ' ');
                                $(this).val(text);
                                return true;
                            }
                        }, maxlength: 100
                    },
                    "history_job[title]": {
                        required: {
                            depends: function () {
                                var text = $.trim($(this).val());
                                text = text.replace(/\s+/g, ' ');
                                $(this).val(text);
                                return true;
                            }
                        }, maxlength: 100
                    },
                    "history_job[location]": {
                        maxlength: {
                            param: 100,
                            depends: function () {
                                var text = $.trim($(this).val());
                                text = text.replace(/\s+/g, ' ');
                                $(this).val(text);
                                return true;
                            }
                        }
                    },
                    "history_job[start_time(2i)]": {required: true, validStartTime: true},
                    "history_job[start_time(1i)]": {required: true},
                    "history_job[end_time(2i)]": {
                        required: function (element) {
                            return $('#history_job_current').is(':unchecked');
                        }, end_time_greater_or_equal_start_time: function (element) {
                            return $('#history_job_current').is(':unchecked');
                        }, validEndTime: true
                    },
                    "history_job[end_time(1i)]": {
                        required: function (element) {
                            return $('#history_job_current').is(':unchecked');
                        }, end_time_greater_or_equal_start_time: function (element) {
                            return $('#history_job_current').is(':unchecked');
                        }
                    },
                    "history_job[description]": {
                        maxlength: {
                            param:2000 ,
                            depends: function () {
                                var text = $.trim($(this).val());
//                                text = text.replace(/\s+/g, ' ');
                                $(this).val(text);
                                return true;
                            }
                        }
                    },
                    "history_job[company_url]": {
                        url: {
                            depends: function () {
                                var text = $.trim($(this).val());
                                text = text.replace(/\s+/g, ' ');
                                $(this).val(text);
                                return true;
                            }
                        }, maxlength: 500
                    }},
                    messages: {
                        "history_job[company_name]": {
                            required: I18n.t('js.validate.msg_required'),
                            maxlength: I18n.t('js.validate.msg_maxlength')
                        },
                        "history_job[title]": {required: I18n.t('js.validate.msg_required')},
                        "history_job[start_time(1i)]": {required: I18n.t('js.validate.msg_required')},
                        "history_job[start_time(2i)]": {
                            required: I18n.t('js.validate.msg_required'),
                            validStartTime: I18n.t('history_job.msg_valid_date')
                        },
                        "history_job[end_time(2i)]": {
                            required: I18n.t('js.validate.msg_required'),
                            end_time_greater_or_equal_start_time: I18n.t('history_job.msg_endtime_greater_starttime'),
                            validEndTime: I18n.t('history_job.msg_valid_date')
                        },
                        "history_job[end_time(1i)]": {
                            required: I18n.t('js.validate.msg_required'),
                            end_time_greater_or_equal_start_time: I18n.t('history_job.msg_endtime_greater_starttime')
                        },
                        "history_job[end_time]": {greater_or_equals: I18n.t('js.validate.msg_greater_than_start_date')},
                        "history_job[description]": {maxlength: I18n.t('js.validate.msg_maxlength')},
                        "history_job[company_url]":{url: I18n.t('js.validate.msg_url_invalid'), maxlength: I18n.t('js.validate.msg_maxlength')}
                    },
                    errorPlacement: function (error, element) {
                        error.insertAfter(element);
                    },
                    submitHandler: function (form) {
                    },
                    invalidHandler: function (form, validator) {
                        $('#div_msg_error').text('');
                        var errors = validator.numberOfInvalids();
                        if (errors) {
                            validator.errorList[0].element.focus();

                        }
                    }

                });
            $.validator.addMethod("end_time_greater_or_equal_start_time", function (value, element) {
                var end_year = $('#history_job_end_time_1i').val();
                var end_month = $("#history_job_end_time_2i").val();
                var end_time = new Date(end_year, end_month);
                var start_year = $('#history_job_start_time_1i').val();
                var start_month = $("#history_job_start_time_2i").val();
                var start_time = new Date(start_year, start_month);
                return (end_time >= start_time)
            }, "end time greater or equal to start time");

            $.validator.addMethod("validStartTime", function (value, element) {
                var start_year = $('#history_job_start_time_1i').val();
                var start_month = $("#history_job_start_time_2i").val();
                var start_time = new Date(start_year, start_month-1,1);
//                alert(start_time);

                return (start_time <= new Date())
            }, "date invalid");
            $.validator.addMethod("validEndTime", function (value, element) {
                var end_year = $('#history_job_end_time_1i').val();
                var end_month = $("#history_job_end_time_2i").val();
                var end_time = new Date(end_year, end_month-1);
                return (end_time <= new Date())
            }, "date invalid ");

            var valid = $("#history_job_form").valid();
            if (!valid) {
                return false;
            }

//            BootstrapDialog.confirm('<%= t('confirm.title_confirm') %>','<%= t('button.btn_save') %>','<%= t('button.btn_cancel') %>','<%= t('educations.msg_confirm_save')%>', function(result){
//                $.loader.open({size:32});
//                if(result) {
            var url = $("#history_job_form").attr("action");
            var data = $("#history_job_form").serializeArray();
            $.ajax({
                type: "POST",
                url: url,
                data: data,
                beforeSend: function (xhr) {
                    $.loader.open({size: 32});
                },
//                        dataType: "script",
                success: function () {
                    $.loader.close(true);
                },
                error: function (xhr, status, response) {
                    console.log("AJAX Error: " + status)
                    $.loader.close(true);
                }
            });
//                }else {
//                    $.loader.close(true);
//                }
//            });
//
        });

    });
</script>

<script>
    function processDeleteHistoryJob(element, e) {
        e.preventDefault();
        var url = $(element).attr("url");
        var id = $(element).attr("objectId");
        var title = $(element).attr("title");
        var title_confirm = $(element).attr("title_confirm");
        var title_msg_confirm = $(element).attr("title_msg_confirm");
        var title_button_ok = $(element).attr("title_button_ok");
        var title_button_cancel = $(element).attr("title_button_cancel");

        BootstrapDialog.confirm(title_confirm, title_button_ok, title_button_cancel, title_msg_confirm, function (result) {
            $.loader.open({size: 32});
            if (result) {
                $.ajax({
                    type: "DELETE",
                    url: url,
                    data: {
                        id: id
                    },
                    beforeSend: function (xhr) {
                        $.loader.open({size: 32});
                    },
                    dataType: "script",
                    success: function () {
                        $.loader.close(true);
                    },
                    error: function (xhr, status, response) {
                        console.log("AJAX Error: " + status)
                        $.loader.close(true);
                    }
                });
            } else {
                $.loader.close(true);
            }
        });
    }
    ;

    function openHistoryJobModal(element, e) {
        e.preventDefault();
        var url = $(element).attr("url");
        var id = $(element).attr("objectId");
        var title = $(element).attr("modal_title");
        $.ajax({
            type: "GET",
            url: url,
            data: {
                id: id
            },
            beforeSend: function (xhr) {
                $.loader.open({size: 32});
            },
            dataType: "script",
            success: function () {
                $.loader.close(true);
                $('#historyJobModal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $("#historyJobModalLabel").text(title);
            },
            error: function (xhr, status, response) {
                console.log("AJAX Error: " + status)
                $.loader.close(true);
            }
        });
    }
    ;

    function openEditHistoryJobModal(element, e) {
        e.preventDefault();
        var url = $(element).attr("url");
        var id = $(element).attr("objectId");
        var title = $(element).attr("modal_title");
        $("#historyJobModalLabel").text(title);
        console.log('openEditHistoryJobModal' + url + id + title)
        $.ajax({
            type: "GET",
            url: url,
            data: {
                id: id
            },
            beforeSend: function (xhr) {
                $.loader.open({size: 32});
            },
            dataType: "script",
            success: function (data) {
                $.loader.close(true);
                console.log("success");
            },
            error: function (xhr, status, response) {
                console.log("AJAX Error: " + status)
                $.loader.close(true);
            }
        });
    }
    ;
</script>
