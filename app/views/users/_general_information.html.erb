<%=stylesheet_link_tag 'crop_image' %>
<div class="widget innerLR">
  <div class="media">
    <!--<div class="pull-left innerAll text-center">-->
    <div class="col-md-2" class="media-body" style="text-align: center">
        <div id="avatar_area" style="margin-top: 20px">
          <div id="avatar">
            <% if !@user.avatar_url.nil? %>
                <%= image_tag @user.avatar_url, class: "img-circle avatar", alt: ""%>
            <% else %>
                <%= image_tag 'noavatar.png', class: "img-circle avatar", alt: ""%>
            <% end %>
          </div>
          <div class="changeavatar">
            <a class="linkChangeAvatar" title=<%= t('users.lb_changeavatar')%> rel="tooltip" href="#" role="button" data-toggle="modal" modal_title="<%=t('users.title_changeavatar')%>">
              <i class="fa fa-camera" style="font-size: 16pt;"></i>
            </a>
          </div>
        </div>
    </div>
    <div id="user_profile" class="media-body">
      <%= render 'basic_information',  locals: {user: @user}  %>
    </div>
  </div>
</div>


</div>

<%= javascript_include_tag 'crop/cropbox' %>
<!-- Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" role="dialog" aria-labelledby="avatarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="avatarModalLabel">Modal title</h4>
      </div>
      <div id="modalAvatarContent" class="modal-body" style="max-height: 700px; overflow-y: auto">

        <%= form_tag change_avatar_path, id: 'change_avatar_form', role: 'form', multipart: true do %>
            <p><span class="small"><%= t('users.help_change_avatar') %></span></p>
          <div class="imageBox">
            <div class="thumbBox"></div>
            <div class="spinner" style="display: none">Loading...</div>
          </div>
          <div class="action">
            <input type="file" id="file" style="float:left; width: 250px">
            <!--<input type="button" id="btnCrop" value="Crop" style="float: right">-->
            <input type="button" id="btnZoomIn" value="+" style="float: right">
            <input type="button" id="btnZoomOut" value="-" style="float: right">
          </div>
          <!--<div class="cropped">-->
          <!--</div>-->
        <% end %>
    </div>

      <div class="modal-footer">
        <button id="btnAvatarSave" type="button" class="btn btn-primary"><%=t('button.btn_save')%></button>
        <button type="button" class="btn btn-default" data-dismiss="modal"><%=t('button.btn_cancel')%></button>
      </div>
    </div>
  </div>
</div>


<script>
    function dataURLtoBlob(dataURL) {
        // Decode the dataURL
        var binary = atob(dataURL.split(',')[1]);
        // Create 8-bit unsigned array
        var array = [];
        for(var i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i));
        }
        // Return our Blob object
        return new Blob([new Uint8Array(array)], {type: 'image/png'});
    }
</script>
<script>
    $(document).ready(function () {
        var options =
        {
            thumbBox: '.thumbBox',
            spinner: '.spinner',
            imgSrc: '<%=image_path('noavatar.png')%>'
        }
        var cropper;


        $('#file').on('change', function(){
            var valid = $("#change_avatar_form").valid();
            if(!valid) {
                return false;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                options.imgSrc = e.target.result;
                cropper = $('.imageBox').cropbox(options);
            }
            reader.readAsDataURL(this.files[0]);
            this.files = [];
        });

        $('#btnZoomIn').on('click', function(){
            cropper.zoomIn();
        });
        $('#btnZoomOut').on('click', function(){
            cropper.zoomOut();
        });

        $('a.linkChangeAvatar').click( function (e) {
            e.preventDefault();
            var title = $(this).attr("modal_title");
            $('#avatarModal').modal({backdrop: 'static',  keyboard: false});
            $("#avatarModalLabel").text(title);

            // remove error
            var file_avatar = $('#file_avatar')
            var parent = file_avatar.parents('.form-group:first');
            parent.removeClass('has-error');
            parent.find('.has-error').remove();

            file_avatar.replaceWith(file_avatar.val('').clone(true));
        });

        $('#avatarModal').on('hidden.bs.modal', function (e) {
            var file_avatar = $('#file_avatar')
            file_avatar.replaceWith(file_avatar.val('').clone(true));
        });


        $("#btnAvatarSave").click(function(){
            $("#change_avatar_form").validate({
                onfocusout: false,
                onkeyup: false,
                    rules: {"file": {required: true, accept_file_extension: 'jpg,jpeg,png'}
                },
                messages: {
                    "file": {required: I18n.t('js.validate.msg_required'), accept_file_extension: I18n.t('js.validate.msg_accept_file_extension')}
                },
                errorPlacement: function (error, element) {
                    error.insertAfter(element);
                },
                submitHandler: function (form) {
                },
                invalidHandler: function (form, validator) {
                    $('#div_msg_error').text('');

                    var errors = validator.numberOfInvalids();
                    if (errors) {
                        validator.errorList[0].element.focus();
                    }
                }
            });

            // valid
            var valid = $("#change_avatar_form").valid();
            if(!valid) {
                return false;
            }

            //upload to server
            // Get our file
            var img = cropper.getDataURL();
            var file= dataURLtoBlob(img);
            // Create new form data
            var data = new FormData();
            // Append our Canvas image file to the form data
            data.append("file_avatar", file);
            // And send it
            $.ajax({
                type: "POST",
                url: "/user/change_avatar",
                data: data,
                processData: false,
                contentType: false,
                dataType: "script",
                beforeSend: function (xhr) {
                    $.loader.open({imgUrl: "<%= asset_path('assets/template/ajaxloader/images/loading16x16.gif') %>"});
                },
                success: function () {
                    $.loader.close(true);
                },
                error: function (xhr, status, response) {
                    console.log("AJAX Error: " + status)
                    $.loader.close(true);
                }
            });
        });
    });
</script>